<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Médica - {{ cedula }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 25px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .patient-info {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .video-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            animation: scaleIn 0.6s ease 0.2s forwards;
            opacity: 0;
            transform: scale(0.9);
        }

        .video-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        #video-frame {
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: block;
            max-width: 100%;
            height: auto;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-width: 320px;
            animation: fadeInUp 0.6s ease 0.4s forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .prediction-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border: 1px solid #e1e8ed;
            width: 100%;
            justify-content: center;
        }

        .toggle-label {
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #95a5a6, #bdc3c7);
            transition: all 0.4s ease;
            border-radius: 30px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: all 0.4s ease;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background: linear-gradient(45deg, #667eea, #764ba2);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }

        input:checked+.slider:before {
            transform: translateX(30px);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:active {
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .action-btn.secondary:hover {
            box-shadow: 0 10px 25px rgba(127, 140, 141, 0.3);
        }

        .action-btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .action-btn.success:hover {
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
        }

        /* Animaciones */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .video-container {
                padding: 15px;
            }

            .controls-section {
                padding: 20px;
                min-width: 280px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .action-btn {
                min-width: auto;
            }

            #video-frame {
                width: 100%;
                max-width: 480px;
            }
        }

        /* Estados de carga */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
            }
        }

        /* --- ESTILOS PARA LA GALERÍA --- */
        .main-container {
            align-items: flex-start;
        }

        .gallery-panel {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            width: 320px;
            position: fixed;
            top: 20px;
            right: 0;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.4s ease-in-out;
            transform: translateX(100%);
            z-index: 100;
        }

        .gallery-panel.visible {
            transform: translateX(-20px);
        }

        .gallery-header {
            text-align: center;
            font-weight: 600;
            color: #4a4a4a;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .gallery-images {
            flex-grow: 1;
            overflow-y: auto;
            display: block;
            padding-right: 10px;
        }

        .gallery-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #888;
            font-size: 16px;
            gap: 10px;
            width: 100%;
        }

        .thumbnail-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .thumbnail-item img {
            width: 100%;
            display: block;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .delete-btn:hover {
            transform: scale(1.1);
            background: rgba(192, 57, 43, 1.0);
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

    <div class="content-wrapper">
        <div class="header">
            <h1><i class="fas fa-video" style="margin-right: 10px;"></i>Evaluación Médica</h1>
            <div class="patient-info">
                <i class="fas fa-id-badge"></i>
                <span>Paciente - Cédula: {{ cedula }}</span>
            </div>
        </div>

        <div class="video-container">
            <div class="status-indicator"></div>
            <img id="video-frame" rc="{{ url_for('camera.video_feed') }}" alt="Transmisión en vivo de la cámara" width="735"
                height="480">
        </div>

        <div class="controls-section" style="margin-top: 20px;">
            <div class="prediction-toggle">
                <div class="toggle-label">
                    <i class="fas fa-brain"></i>
                    <span>Predicción de IA</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="predictionSwitch" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <!-- === Perillas RKNN === -->
            <div id="rknn-knobs" style="width:100%; display:flex; flex-direction:column; gap:16px;">
                <div style="font-weight:600; color:#2c3e50; text-align:center;">Ajustes de detección</div>

                <label style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
                    <span style="min-width:160px;">Confianza (conf_th)</span>
                    <input id="conf_th" type="range" min="0" max="1" step="0.01" value="0.60" style="flex:1;">
                    <span id="conf_th_val" style="width:56px; text-align:right;">0.60</span>
                </label>

                <label style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
                    <span style="min-width:160px;">IoU NMS (iou_th)</span>
                    <input id="iou_th" type="range" min="0" max="1" step="0.01" value="0.30" style="flex:1;">
                    <span id="iou_th_val" style="width:56px; text-align:right;">0.30</span>
                </label>

                <label style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
                    <span style="min-width:160px;">Tamaño mínimo caja</span>
                    <input id="min_box_frac" type="range" min="0.001" max="0.02" step="0.001" value="0.003" style="flex:1;">
                    <span id="min_box_frac_val" style="width:56px; text-align:right;">0.003</span>
                </label>

                <div class="button-group" style="margin-top:4px;">
                    <button type="button" id="resetKnobs" class="action-btn secondary">
                    <i class="fas fa-rotate-left"></i><span>Restaurar</span>
                    </button>
                </div>
            </div>
            <!-- === /Perillas RKNN === -->

            <div class="button-group">
                <button type="button" id="captureButton" class="action-btn success"><i
                        class="fas fa-camera"></i><span>Capturar Imagen</span></button>
                <button type="button" id="galleryButton" class="action-btn"><i class="fas fa-images"></i><span>Ver
                        Galería</span></button>
                <a href="{{ url_for('pages.download_data', cedula=cedula) }}" class="action-btn"><i
                        class="fas fa-download"></i><span>Descargar Datos</span></a>
                <button type="button" id="backButton" class="action-btn secondary"><i
                        class="fas fa-arrow-left"></i><span>Regresar</span></button>
            </div>
        </div>
    </div>
    <div id="galleryPanel" class="gallery-panel">
        <h2 class="gallery-header">Capturas</h2>
        <div id="galleryImages" class="gallery-images">
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        $(document).ready(function () {
            const cedula = '{{ cedula }}';

            // --- LÓGICA DE LA GALERÍA ---
            const galleryPanel = $('#galleryPanel');
            const galleryImages = $('#galleryImages');

            // Función para añadir una miniatura a la galería
            function addThumbnail(filename) {
                const thumbnailUrl = `/resultados_prueba/${cedula}/${filename}?t=${new Date().getTime()}`;
                const item = $(`
                <div class="thumbnail-item" data-filename="${filename}">
                    <img src="${thumbnailUrl}" alt="Captura">
                    <button class="delete-btn"><i class="fas fa-times"></i></button>
                </div>
            `);
                galleryImages.append(item);
            }

            // Función para cargar todas las capturas existentes al iniciar
            // Reemplaza tu función loadCaptures con esta versión mejorada
        function loadCaptures() {
            galleryImages.html('<div class="gallery-loader"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>');
            
            $.getJSON(`/get_capturas/${cedula}`, function(files) {
                
                if (files.length === 0) {
                    galleryImages.html('<p style="text-align:center; color:#888;">No hay capturas.</p>');
                    return;
                }
                
                const tempContainer = $('<div></div>');
                let imagesLoaded = 0;
                
                files.forEach(filename => {
                    const thumbnailUrl = `/resultados_prueba/${cedula}/${filename}?t=${new Date().getTime()}`;
                    const item = $(`
                        <div class="thumbnail-item" data-filename="${filename}">
                            <img src="${thumbnailUrl}" alt="Captura">
                            <button class="delete-btn"><i class="fas fa-times"></i></button>
                        </div>
                    `);
                    
                    item.find('img').on('load', function() {
                        imagesLoaded++;
                        if (imagesLoaded === files.length) {
                            galleryImages.html(tempContainer.html());
                        }
                    });
                    
                    tempContainer.append(item);
                });
            });
        }

            // Evento para mostrar/ocultar la galería
            $('#galleryButton').click(function () {
                $('#galleryPanel').toggleClass('visible');
            });

            // Evento para borrar una imagen
            galleryImages.on('click', '.delete-btn', function () {
                const item = $(this).closest('.thumbnail-item');
                const filename = item.data('filename');
                const button = $(this);
                const originalIconClass = button.find('i').attr('class');

                setButtonLoading(button, true);

                $.ajax({
                    url: '/delete_captura',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ filename: filename, cedula: cedula }),
                    success: function (response) {
                        if (response.success) {
                            showNotification('Imagen eliminada', 'success');
                            loadCaptures();
                        } else {
                            showNotification(response.message || 'Error al eliminar', 'error');
                        }
                    },
                    error: function () {
                        showNotification('Error de comunicación al eliminar', 'error');
                    },
                    complete: function () {
                        setButtonLoading(button, false);
                        button.find('i').removeClass().addClass(originalIconClass);
                    }
                });
            });

            // --- LÓGICA DE CAPTURA ---
            $('#captureButton').click(function () {
                const video = document.getElementById('video-frame');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                var button = $(this);
                var originalIcon = button.find('i').attr('class');

                setButtonLoading(button, true);

                canvas.width = video.naturalWidth;
                canvas.height = video.naturalHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(function (blob) {
                    const formData = new FormData();
                    formData.append('cedula', cedula);
                    formData.append('image', blob, 'captura.jpg');

                    $.ajax({
                        url: "{{ url_for('camera.capture') }}",
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (data) {
                            showNotification(data.message || 'Imagen capturada', 'success');
                            if (data.filename) {
                                loadCaptures();
                            }
                        },
                        error: function () {
                            showNotification('Error al capturar', 'error');
                        },
                        complete: function () {
                            setButtonLoading(button, false);
                            button.find('i').removeClass().addClass(originalIcon);
                        }
                    });
                }, 'image/jpeg');
            });

            // --- OTRAS FUNCIONES ---
            $('#backButton').click(function () {
                window.location.href = "{{ url_for('pages.index') }}";
            });

            $('#predictionSwitch').change(function () {
                $.post("{{ url_for('camera.toggle_predictions') }}", { enabled: this.checked });
            });

            // === Perillas RKNN (front) ===
            function setLabel(id, v) { $(`#${id}_val`).text(Number(v).toFixed(3).replace(/0+$/,'').replace(/\.$/,'.0')); }
            function setInput(id, v) { $(`#${id}`).val(v); setLabel(id, v); }

            // Cargar valores actuales desde la API
            function fetchThresholds() {
            $.getJSON('/thresholds')
                .done(th => {
                if (typeof th.conf_th === 'number') setInput('conf_th', th.conf_th);
                if (typeof th.iou_th === 'number') setInput('iou_th', th.iou_th);
                if (typeof th.min_box_frac === 'number') setInput('min_box_frac', th.min_box_frac);
                })
                .fail(() => showNotification('No se pudieron cargar las perillas', 'error'));
            }

            // Debounce para no spamear el backend al mover sliders
            let knobsTimer = null;
            function pushThresholds(payload) {
            clearTimeout(knobsTimer);
            knobsTimer = setTimeout(() => {
                $.ajax({
                url: '/thresholds',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload)
                })
                .done(res => {
                // opcional: showNotification('Ajustes aplicados', 'success');
                })
                .fail(() => showNotification('Error al aplicar ajustes', 'error'));
            }, 150);
            }

            // Handlers de cambio (envían sólo el campo modificado)
            $('#conf_th').on('input change', function() {
            setLabel('conf_th', this.value);
            pushThresholds({ conf_th: parseFloat(this.value) });
            });
            $('#iou_th').on('input change', function() {
            setLabel('iou_th', this.value);
            pushThresholds({ iou_th: parseFloat(this.value) });
            });
            $('#min_box_frac').on('input change', function() {
            setLabel('min_box_frac', this.value);
            pushThresholds({ min_box_frac: parseFloat(this.value) });
            });

            // Reset a valores por defecto del backend
            $('#resetKnobs').on('click', function() {
            const btn = $(this), icon = btn.find('i').attr('class');
            setButtonLoading(btn, true);
            $.post('/thresholds/reset')
                .done(res => {
                setInput('conf_th', res.thresholds.conf_th);
                setInput('iou_th', res.thresholds.iou_th);
                setInput('min_box_frac', res.thresholds.min_box_frac);
                showNotification('Perillas restauradas', 'success');
                })
                .fail(() => showNotification('No se pudo restaurar', 'error'))
                .always(() => {
                setButtonLoading(btn, false);
                btn.find('i').removeClass().addClass(icon);
                });
            });

            // Inicializa perillas al cargar
            fetchThresholds();
            // === /Perillas RKNN ===


            // Tu código de showNotification y setButtonLoading
            function showNotification(message, type = 'success') {
                const notification = $(`
                <div class="notification ${type}" style="
                    position: fixed; top: 20px; right: 20px;
                    background: ${type === 'success' ? 'linear-gradient(135deg, #27ae60, #2ecc71)' : 'linear-gradient(135deg, #e74c3c, #c0392b)'};
                    color: white; padding: 15px 25px; border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 1000;
                    font-family: 'Poppins', sans-serif; font-weight: 500;
                    display: flex; align-items: center; gap: 10px;
                    transform: translateX(400px); transition: all 0.4s ease;
                ">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    ${message}
                </div>
            `);
                $('body').append(notification);
                setTimeout(() => { notification.css('transform', 'translateX(0)'); }, 100);
                setTimeout(() => {
                    notification.css('transform', 'translateX(400px)');
                    setTimeout(() => notification.remove(), 400);
                }, 3000);
            }

            function setButtonLoading(button, loading = true) {
                if (loading) {
                    button.addClass('loading');
                    button.find('i').removeClass().addClass('fas fa-spinner fa-spin');
                } else {
                    button.removeClass('loading');
                }
            }

            loadCaptures();
        });
    </script>

</body>

</html>